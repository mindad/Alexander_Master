<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>Brewmiester Production</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!--<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <link href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
    <script src="../../Scripts/ajaxCalls.js"></script>



    <script>

        inventoryArr = [];
        //productArr = [];
        // TODO
        // form rendering when submitted
        // Add new product type (new product to the Product_2020)
        // create a select that holds prodType options

        $(document).ready(function () {

            $("#addDiv").hide();
            $('#editDiv').hide();
            $('#submit_edit').on("click", edit_Inventory_table);
            $('#submit_add').on("click", submit_Inventory_item);
            $("#editForm").on('submit', f1);

            ajaxCall("GET", "../../api/Product", "", GetProductSucess, GetProductError); // get all products

            ajaxCall("GET", "../../api/Product/Inventory", "", GetInventorySucess, GetInventoryError); // get all inventory products

            // DT events for Plus btn
            $('#tbl').on('click', 'td.details-control', function () {

                var tr = $(this).closest('tr');
                var row = $('#tbl').DataTable().row(tr);

                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    row.child(format(row.data())).show();
                    tr.addClass('shown');

                    let newArr = [];

                    for (prod of inventoryArr) {
                        if (prod.ProductID == row.data().ProductID) {
                            newArr.push(prod);
                        }
                    }

                    createDT(newArr); // create DT based on product name

                }
            });
            // ** DT events for Plus btn

            buttonEvents(); // initialize DT buttons activity
        });

        function createDT(DT_data) {

            try {
                $(`#tbl-${DT_data[0].ProductName}`).DataTable({
                        "paging": false,
                        "ordering": false,
                        "info": false,
                        "searching": false,
                        data: DT_data,
                        pageLength: 3,
                        columns: [
                            {
                                data: {  },
                                render: function (data, type, row, meta) {

                                    //console.log(data);

                                    let data_for_tbl = "data-btnId='" + data.ProductName + "'" + "data-Date='" + data.Last_arrivalTime + "'";

                                    editBtn = "<button type='button' class = 'editBtn btn btn-success'" + data_for_tbl + "> Edit </button>";
                                    deleteBtn = "<button type='button' class = 'deleteBtn btn btn-danger'" + data_for_tbl + "> Delete </button>";
                                    return editBtn + deleteBtn;
                                }
                            },
                            { data: "Amount" },
                            {
                                data: "Last_arrivalTime",
                                render: function (data) {
                                    return data.substr(0, 10);
                                }

                            },
                        ]
               });
            }
               

            catch (err) {
                alert(err);
            }

        }

 
        // adds table with all inventory inputs

        function format(d) {
            // `d` is the original data object for the row
            console.log(d);

            return (
                `<table id="tbl-${d.ProductName}" class="display" border="1" style="width:100%">
                    <thead style="background-color:cornflowerblue">
                        <tr>
                            <th></th>
                            <th>Amount</th>
                            <th>Last Arrival Date</th>
                        </tr>
                     </thead>
                    <tbody>
                    </tbody>
                 </table>`
            );
        }


        // Product API
        function GetProductSucess(Product_data) {

            console.log('this is product data:', Product_data);

            //productArr = Product_data;


            try {
                $('#tbl').DataTable({

                    data: Product_data,
                    pageLength: 5,
                    columns: [             
                        {
                            "className": 'details-control',
                            "orderable": false,
                            "data": null,
                            "defaultContent": ''
                        },
                        { data: "ProductName" },  
                        { data: "Amount" }, 
                        {
                            data: "Last_arrivalTime",
                            render: function (data, type, row, meta) {
                                return data.substr(0,10);
                            }
                        },
                        { data: "Min_amount" },
                        {
                            data: {},
                            render: function (data, type, row, meta) {

                                let data_for_tbl = "data-prod_Id='" + data.ProductID + "'" + "data-prod_Name='" + data.ProductName + "'";

                                addBtn = "<button type='button' class = 'addBtn btn btn-success'" + data_for_tbl + "> Add </button>";
                                return addBtn;
                            }
                        }
                    ]
                });
            }

            catch (err) {
                alert(err);
            }
        }

        function GetProductError(err) {
            console.log(err);
        }
        // ** Product API

        // Invenotry API
        function GetInventorySucess(data) {
            console.log('this is inventory data:',data); // yeast A is the common one

            inventoryArr = data;
        }
        function GetInventoryError(err) {
            console.log(err);
        }
        // ** Invenotry API


        // Button Events
        function buttonEvents() {

            $(document).on("click", ".editBtn", function () {

                populateFields(this.getAttribute('data-btnId'), this.getAttribute('data-Date').substr(0,10)); // fill the form fields according to the selected row
            });


            $(document).on("click", ".deleteBtn", function () {

                prod_TO_delete = {
                     productType: '',
                     amount: 0,
                     min_amount: 0,
                     last_arrivalTime: this.getAttribute('data-Date'),
                     productName: this.getAttribute('data-btnid'),
                     productID: 0
                }

                //console.log('this is DELETE prod_id:', prod_TO_delete);

                if (confirm("Are You Sure You Want To Delete This Row?")) {

                    ajaxCall("Delete", "../../api/Product/Inventory", JSON.stringify(prod_TO_delete), DeleteInventorySucess, DeleteInventoryError); 
                }
                else {
                    console.log("You pressed Cancel!");
                }
            });


            $(document).on("click", ".addBtn", function () { // add existing product to inventory
                

                $("#ph").val(this.getAttribute('data-prod_Id'));
                $("#ph1").val(this.getAttribute('data-prod_Name'));

                let UniqueNames= $.unique(inventoryArr.map(function (d) {return d.ProductType;})); // get unique product types

                // insert values to beerType Select     
                prodTypesOptions = "<option>Select Product Type</option>`";
                for (name of UniqueNames) {
                    prodTypesOptions += `<option>${name}</option>`;
                }

                $("#addDiv").show();
                document.getElementById("prod_type_select").innerHTML = prodTypesOptions;

                
            });
        }


        // add inventory item
        function submit_Inventory_item() {

            let prod = {
               productType:$("#prod_type_select").val(),
               amount: $("#amountTypeInput_add").val(),
               min_amount:0,
               last_arrivalTime:$("#DateInput_add").val(),
               productName:$('#ph1').val(),
               productID:$('#ph').val()
            }

            console.log('this is prod that will send to POST', prod);
          
            ajaxCall("POST", "../../api/Product/Inventory", JSON.stringify(prod), add_InventorySucess, add_InventoryError);

            $("#addDiv").hide();

            return false; // form submit
        }

        function add_InventorySucess(data) {
            console.log(data, 'record changed succefully');

            refresh_table();

        }
        function add_InventoryError(err) {
            console.log(err);
        }
        // ** add inventory item

        //////// edit inventory item
        function edit_Inventory_table() {

            let prod = {
               productType:$('#ph1').val(),
               amount: $("#amountTypeInput").val(),
               min_amount:0,
               last_arrivalTime:$("#DateInput").val(),
               productName:$('#ph').val(),
               productID:0
            }

            console.log('this is prod that will send to PUT', prod);
          
            ajaxCall("PUT", "../../api/Product/Inventory", JSON.stringify(prod), edit_InventorySucess, edit_InventoryError);

            return false; // form submit
        }

        function edit_InventorySucess(data) {
            console.log(data, 'record changed succefully');

            refresh_table();

        }
        function edit_InventoryError(err) {
            console.log(err);
        }
        //****** edit inventory item
        
        //////// add invenotry item
        function DeleteInventorySucess(data) {
            console.log(data, "Record Deleted");

            refresh_table();
            
        }

        function DeleteInventoryError(err) {
            console.log(err);
        }
        //****** add invenotry item

        // ** Button Events


        function populateFields(product_name, product_date) { // set values in edit DIV

            console.log('populate fileds:', product_name, product_date);
            $("#editDiv").show();

            for (prod of inventoryArr) {

                //console.log(prod.ProductName);
                //console.log(prod.Last_arrivalTime.substr(0, 10));

                
                if (prod.ProductName == product_name && prod.Last_arrivalTime.substr(0,10) == product_date) {
                    $("#amountTypeInput").val(prod.Amount);
                    $("#DateInput").val(prod.Last_arrivalTime.substr(0, 10)); 

                    $("#ph").val(product_name); // holds productName to edit
                    $("#ph1").val(product_date); // holds last_arrival_Date to edit
                }
            }

        }

        function refresh_table() {

            location.reload();
        }

           function f1(e) {
            return false; // form submit
        }

    </script>



    <style>
        body {
            background-color: #f7f6f6;
            padding-bottom: 1%;
        }

        #headerRow {
            height: 180px;
        }

        .navbar {
            height: 70px;
        }

        table {
            text-align: center;
        }
        #addprod {
            text-align: center;
            margin-top: 100px;
            margin: auto;
            width: 60%;
            border: solid 2px;
            background-color: aliceblue;
        }

        .container {
            padding-bottom: 4%;
        }

        td.details-control {
            background: url('../Images/details_open.png') no-repeat center center;
            cursor: pointer;
        }

        tr.shown td.details-control {
            background: url('../Images/details_close.png') no-repeat center center;
        }
    </style>

</head>

<body>
    <!-- NavBar Template -->
    <div class="header text-center">
        <nav class="navbar navbar-expand-lg navbar-light border-bottom" style="background-color: #f7f6f6;">
            <a class="navbar-brand" href="Brewmiester-dashboard.html">Home</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item active">
                        <a class="nav-link" href="Brewmiester-prod.html">Production</a>
                    </li>
                    <li class="nav-item active px-2">
                        <a class="nav-link" href="Inventory.html">Inventory</a>
                    </li>
                    <li class="nav-item active px-2">
                        <a class="nav-link" href="#">Waste</a>
                    </li>
                    <li class="nav-item active px-2">
                        <a class="nav-link" href="Alerts.html">Alerts</a>
                    </li>
                    <!-- <li class="nav-item">
                      <a class="nav-link disabled" href="#">Disabled</a>
                    </li> -->
                </ul>
            </div>
            <a class="navbar-brand" href="#">
                <img src="../Images/Logo_alexander.jpeg" height="68" alt="alexander logo">
            </a>
        </nav>
    </div>
    <br>
    <!-- NavBar Template -->
    <!-- table -->
    <div class="container">
        <table id="tbl" class="display" border="1" style="width:100%">
            <thead style="background-color:cornflowerblue">
                <tr>
                    <th></th> <!--Plus sign-->
                    <th>Product Name</th>
                    <th>Amount</th>
                    <th>Last Arrival Date</th>
                    <th>Minimum Amount</th>
                    <th></th> <!--Edit + Add-->
                </tr>
            </thead>
            <tbody>
            </tbody>

        </table>

        <!--<button id="add_new_cook" data-toggle='collapse' data-target='#addprodContainer' aria-expanded='false' aria-controls='addprodContainer'>Add</button>-->
        <!-- collapse/Expend the addprodcontianer (bootstrap) data-toggle='collapse' data-target='#addprodContainer' aria-expanded='false' aria-controls='addprodContainer' -->

    </div>
    <!-- table -->
    <!-- Add Product -->
    <div class="container collapse" id="addprodContainer">
        <div id="addprod">
            <br />
            <form id="ourForm">
                <select name="Beer" id="beerSelect"></select>
                <br><br>
                <label>Choose date</label>
                <input type="date" name="date" id="addDate">
                <br><br>

                <div id="inForm"></div>

                <button id="addToBatch" type="submit">Submit</button>
                <br /><br />
            </form>
        </div>
    </div>
    <!-- Add Product -->
    <!--Edit Row In Table-->
    <div class="container" id="editDiv">
        <form id="editForm">
            <div class="form-group">
                <label for="">Amount</label>
                <input type="text" class="form-control" id="amountTypeInput" required />
                <br />
                <label for="fromDate">Date</label>
                <input type="date" class="form-control" id="DateInput" required />
                <br />
            </div>
            <button id="submit_edit">Submit</button>
        </form>
    </div>
    <!--Edit Row In  Table-->
    <!--ADD Row In Table-->
    <div class="container" id="addDiv">
        <form id="addForm">
            <div class="form-group">
                <!-- TODO create a select that holds prodType options-->
                <select name="Beer" id="prod_type_select"></select>
                <br />
                <label for="">Amount</label>
                <input type="text" class="form-control" id="amountTypeInput_add" required />
                <br />
                <label for="fromDate">Date</label>
                <input type="date" class="form-control" id="DateInput_add" required />
                <br />
            </div>
            <button id="submit_add">Submit</button>
        </form>
    </div>
    <!--ADD Row In Table-->
    <div id="ph"></div>
    <div id="ph1"></div>
</body>

</html>