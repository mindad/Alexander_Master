<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>Brewmiester Production</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!--<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <link href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
    <script src="../../Scripts/ajaxCalls.js"></script>



    <script>

        //TODO
        //
        // add ADD button for each table
        // make EDIT logic for each table
        //
       

        batch_id = null; // current batch

        $(document).ready(function () {

            batch_id = decodeURI(document.location.search).replace(/[^0-9]/g, '');

            batch_id = 3;

            ajaxCall('GET', '../../api/Batch_Production', '', GetBatchSuccess, GetBatchError); // check if exist and bring values into tables
            ajaxCall('GET', '../../api/SampleDetails', '', GetSampleSuccess, GetSampleError);// tbl-sample
            ajaxCall('GET', '../../api/Purge', '', GetPurgeSuccess, GetPurgeError); //tbl-purge
            ajaxCall('GET', '../../api/Harvest', '', GetHarvestSuccess, GetHarvestError); //tbl-harvest
            ajaxCall('GET', '../../api/Fermantation', '', GetFermantationSuccess, GetFermantationError); //tbl-Fermant

            //buttonEvents();
        });



        // Batch API
        function GetBatchSuccess(data) {
            console.log('Batch At Production Data:', data);

            let batch; // find current batch

            for (let bt of data) {
                if (batch_id == bt.BatchID) {
                    batch = bt;
                    break;
                }
            }

            // build simple table as for the excel
            let st = `
                <tr>
                    <th colspan="2">Tank #:
                    <input type="text" class="" value="${batch.Tank}" disabled/>
                    </th>
                    <th>Beer Type:
                    <input type="text" class="" value="${batch.BeerType}" disabled/>
                    </th>
                </tr>
                <tr>
                    <th colspan="2">Brew Date:
                    <input type="text" class="" value="${(batch.Date).substr(0, 10)}" disabled/>
                    </th>
                    <th>Batch #:
                    <input type="text" class="" value="${batch.BatchID}" disabled/>
                    </th>
                </tr>
                <tr>
                    <th>Yeast Cycle: <input type="text" class="" value="${batch.Yeast_cycle}"/> </th>
                    <th>Pitch Time: <input type="text" class="" value="${batch.PitchTime}"/></th>
                    <th colspan="2">Pitching Rate: <input type="text" class="" value="${batch.Pitching_rate}"/></th>
                </tr>
                <tr>
                    <th>Cast Vol: <input type="text" class="" value="${batch.Cast_volume}"/></th>
                    <th>O.G: <input type="text" class="" value="${batch.Og}"/></th>
                    <th colspan="2">O - Temp - Tank: <input type="text" class="" value="${batch.Tank_temp}"/></th>
                </tr>
                <tr>
                    <th>co2 Vol: <input type="text" class="" value="${batch.Co2_vol}"/></th>
                    <th>F.G: <input type="text" class="" value="${batch.Fg}"/></th>
                    <th colspan="2">Set - Temp: <input type="text" class="" value="${batch.Set_temp}"/></th>
                </tr>`
            $('#batchTBL').html(st);
        }
        function GetBatchError(err) {
            console.log(err);
        }
        // ** Batch API

        // Sample API
        function GetSampleSuccess(samples) {
            console.log('sample Details:' ,samples);

            //batch_id = 3;
            let smp = [];

            for (let sample of samples) {
                if (sample.Batch_id == batch_id) {
                    smp.push(sample);
                }
            }

            console.log('this is smp:', smp);
            let blabla = { 1: 1, 2: 2, 3: 3 };

            try {
                $('#tbl-sample').DataTable({
                    "paging": false,
                    "ordering": false,
                    "info": false,
                    "searching": false,
                    data: smp,
                    pageLength: 5,
                    columns: [
                        {
                            data: "Row_num",
                            render: function (data) { 

                                let data_for_tbl = "data-Sample-btnId='" + data + "'";

                                editBtn = "<button type='button' class = 'editSampleBtn btn btn-success'" + data_for_tbl + "> Edit </button>";
                                deleteBtn = "<button type='button' class = 'deleteSampleBtn btn btn-danger'" + data_for_tbl + "> Delete </button>";
                                addBtn =  "<button type='button' class = 'addSampleBtn btn btn-warning'" + data_for_tbl + "> Add </button>";
                                return addBtn + editBtn + deleteBtn;
                            }
                        },  
                        {
                            data: "Date",
                            render: function (data) {
                                return data.substr(0, 10);
                            }
                        },
                        { data: "Tank_temp" },
                        { data: "Sample_temp" },
                        { data: "Rate" },
                        { data: "Gravity" },
                        { data: "Ph" },
                        { data: "Notes" },
                    ]
                });
            }

            catch (err) {
                alert(err);
            }

            buttonEvents();
        }
        function GetSampleError(err) {
            console.log(err);
        }
        // ** Sample API

        // Purge API
        function GetPurgeSuccess(purges) {
            console.log('purges:', purges);

            batch_id = 3;
            let prg = [];

            for (let purge of purges) {
                if (purge.Batchid == batch_id) {
                    prg.push(purge);
                }
            }

            console.log('this is prg:', prg);


            try {
                $('#tbl-purge').DataTable({
                    "paging": false,
                    "ordering": false,
                    "info": false,
                    "searching": false,
                    data: prg,
                    pageLength: 5,
                    columns: [
                        {
                            data:"Row_num",
                            render: function (data, type, row, meta) {

                                let data_for_tbl = "data-Purge-btnId='" + data + "'";

                                editBtn = "<button type='button' class = 'editPurgeBtn btn btn-success'" + data_for_tbl + "> Edit </button>";
                                deleteBtn = "<button type='button' class = 'deletePurgeBtn btn btn-danger'" + data_for_tbl + "> Delete </button>";
                                addBtn =  "<button type='button' class = 'addPurgeBtn btn btn-warning'" + data_for_tbl + "> Add </button>";
                                return addBtn + editBtn + deleteBtn;
                            }
                        },
                        {
                            data: "Date",
                            render: function (data) {
                                return data.substr(0, 10);
                            }
                        },
                        { data: "Name"},
                        { data: "Temperature"},
                        { data: "Weight" },
                        { data: "Num_of_buckets" },
                        { data: "Notes" },
                    ]
                });
            }

            catch (err) {
                alert(err);
            }

            buttonEvents();
        }
        function GetPurgeError(err) {
            console.log(err);
        }
        // ** Purge API


        // Harvest API
        function GetHarvestSuccess(harvests) {
            console.log('Harvests:', harvests);

            let harvest = [];

            for (let hr of harvests) {
                if (hr.Batchid == batch_id) {
                    harvest.push(hr);
                }
            }

            console.log('this is harvest:', harvest);


            try {
                $('#tbl-harvest').DataTable({
                    "paging": false,
                    "ordering": false,
                    "info": false,
                    "searching": false,
                    data: harvest,
                    pageLength: 5,
                    columns: [
                        {
                            data:"Row_num",
                            render: function (data, type, row, meta) {

                                let data_for_tbl = "data-Harvest-btnId='" + data + "'";

                                editBtn = "<button type='button' class = 'editHarvestBtn btn btn-success'" + data_for_tbl + "> Edit </button>";
                                deleteBtn = "<button type='button' class = 'deletHarvestBtn btn btn-danger'" + data_for_tbl + "> Delete </button>";
                                addBtn =  "<button type='button' class = 'addHarvestBtn btn btn-warning'" + data_for_tbl + "> Add </button>";
                                return addBtn + editBtn + deleteBtn;
                            }
                        },
                        {
                            data: "Date",
                            render: function (data) {
                                return data.substr(0, 10);
                            }
                        },
                        { data: "Name"},
                        { data: "Temperature"},
                        { data: "Time_tap_2" },
                        { data: "Total_Duration" },
                    ]
                });
            }

            catch (err) {
                alert(err);
            }

            buttonEvents();
        }
        function GetHarvestError(err) {
            console.log(err);
        }

        // ** Harvest API

        // Fermantation API
        function GetFermantationSuccess(Fermantation) {
            console.log('Fermantation:', Fermantation);

            let fermant = [];

            for (let fr of Fermantation) {
                if (fr.Batchid == batch_id) {
                    fermant.push(fr);
                }
            }

            console.log('this is fermant:', fermant);


            try {
                $('#tbl-Fermant').DataTable({
                    "paging": false,
                    "ordering": false,
                    "info": false,
                    "searching": false,
                    data: fermant,
                    pageLength: 5,
                    columns: [
                        {
                            data:"Row_num",
                            render: function (data, type, row, meta) {

                                let data_for_tbl = "data-Fermantation-btnId='" + data + "'";

                                editBtn = "<button type='button' class = 'editFermantationBtn btn btn-success'" + data_for_tbl + "> Edit </button>";
                                deleteBtn = "<button type='button' class = 'deleteFermantationBtn btn btn-danger'" + data_for_tbl + "> Delete </button>";
                                addBtn =  "<button type='button' class = 'addFermantationBtn btn btn-warning'" + data_for_tbl + "> Add </button>";
                                return addBtn + editBtn + deleteBtn;
                            }
                        },
                        {
                            data: "Date",
                            render: function (data) {
                                return data.substr(0, 10);
                            }
                        },
                        { data: "PressureChange"},
                        { data: "Tank_pressure" },
                        { data: "Tank_temperature" }
                    ]
                });
            }

            catch (err) {
                alert(err);
            }

            buttonEvents();
        }
        function GetFermantationError(err) {
            console.log(err);
        }

        // ** Fermantation API


        // Global Functions


        //////// edit + delete
        function buttonEvents() {

            $(document).on("click", ".editSampleBtn,.editHarvestBtn,.editPurgeBtn,.editFermantationBtn", function () {

                let tbl_name = $(this).attr('class').replace(/^edit/, '').replace(/Btn.+/, ''); 
                console.log("tbl_name is:",tbl_name.toLowerCase())

                Edit_Row_In_TBL(this.getAttribute(`data-${tbl_name.toLowerCase()}-btnid`), tbl_name); //

                //populateFields(this.getAttribute('data-btnId')); // fill the form fields according to the selected row
            });

            $(document).on("click", ".deleteSampleBtn,.deleteHarvestBtn,.deletePurgeBtn,.deleteFermantationBtn", function () {

                let tbl_name = $(this).attr('class').replace(/^delete/, '').replace(/Btn.+/, ''); 
                console.log("tbl_name is:", tbl_name.toLowerCase());

                Delete_Row_In_TBL(this.getAttribute(`data-${tbl_name.toLowerCase()}-btnid`), tbl_name);

            });

            $(document).on("click", ".addSampleBtn,.addHarvestBtn,.addPurgeBtn,.addFermantationBtn", function () {

                let tbl_name = $(this).attr('class').replace(/^add/, '').replace(/Btn.+/, ''); 
                console.log("tbl_name is:", tbl_name.toLowerCase());

                Add_Row_In_TBL(this.getAttribute(`data-${tbl_name.toLowerCase()}-btnid`), tbl_name);

            });
        }

        function Edit_Row_In_TBL(row_id, tbl_name) {

            console.log('row_id:', row_id);

            Hide_Tables(tbl_name);

            if (tbl_name == "Sample") {

            }
            if (tbl_name == "Purge") {

            }
            if (tbl_name == "Harvest") {

            }
            if (tbl_name == "Fermantation") {

            }
        }

        function Delete_Row_In_TBL(row_id, tbl_name) {

            console.log('row_id:', row_id);

            if (tbl_name == "Sample") {

                if (confirm("Are You Sure You Want To Delete This Row?")) {

                    //ajaxCall("Delete", "../../api/Batch", JSON.stringify(batch_id), DeleteBatchSucess, DeleteBatchError); 
                }
                else {
                    alert("You pressed Cancel!");
                }

            }
            if (tbl_name == "Purge") {

            }
            if (tbl_name == "Harvest") {

            }
            if (tbl_name == "Fermantation") {

            }
        }

        function Hide_Tables(tbl_name) {

            let tbl_list = ['sample_div', 'purge_div', 'harvest_div', 'fermant_div'];
            tbl_list.pop(tbl_name); // removes tbl_name from list

            for (tbl of tbl_list) {
                $(`#${tbl}`).hide(); 
            }
            
        }

    </script>



    <style>
        body {
            background-color: #f7f6f6;
            padding-bottom: 1%;
        }

        #headerRow {
            height: 180px;
        }

        .navbar {
            height: 70px;
        }

        table {
            text-align: center;
        }

        .container {
            padding-bottom: 1%;
        }

        #notes_input {
            height: 15%;
            width: 80%;
        }
        /*tbl CSS*/
        table,
        th,
        td {
            border: 1px solid black;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 5px;
        }

        input[type=text] {
            background-color: #f7f6f6;
        }
    </style>

</head>

<body>
    <!-- NavBar Template -->
    <div class="header text-center">
        <nav class="navbar navbar-expand-lg navbar-light border-bottom" style="background-color: #f7f6f6;">
            <a class="navbar-brand" href="Brewmiester-dashboard.html">Home</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item active">
                        <a class="nav-link" href="Brewmiester-prod.html">Production</a>
                    </li>
                    <li class="nav-item active px-2">
                        <a class="nav-link" href="Inventory.html">Inventory</a>
                    </li>
                    <li class="nav-item active px-2">
                        <a class="nav-link" href="#">Waste</a>
                    </li>
                    <li class="nav-item active px-2">
                        <a class="nav-link" href="Alerts.html">Alerts</a>
                    </li>
                    <!-- <li class="nav-item">
                      <a class="nav-link disabled" href="#">Disabled</a>
                    </li> -->
                </ul>
            </div>
            <a class="navbar-brand" href="#">
                <img src="../Images/Logo_alexander.jpeg" height="68" alt="alexander logo">
            </a>
        </nav>
    </div>
    <br>
    <!-- NavBar Template -->
    <!-- table - General-->
    <div class="container">
        <h1 class="text-center">Batch</h1><br />
        <table class="display" border="1" style="width:100%" id="batchTBL">
        </table>
    </div>
    <!-- table -->
    <!-- table - sample Details-->
    <div class="container" id="sample_div">
        <h5 class="text-center">Sample Details</h5>
        <table id="tbl-sample" class="display" border="1" style="width:100%">
            <thead style="background-color:cornflowerblue">
                <tr>
                    <th></th> <!--edit/delete buttons-->
                    <th>Date</th>
                    <th>Tank Temperature</th>
                    <th>Sample Temperature</th>
                    <th>Rate</th>
                    <th>Gravity</th>
                    <th>PH</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
            </tbody>

        </table>

        <!--<button id="add_new_cook" data-toggle='collapse' data-target='#addprodContainer' aria-expanded='false' aria-controls='addprodContainer'>Add</button>-->
        <!-- collapse/Expend the addprodcontianer (bootstrap) data-toggle='collapse' data-target='#addprodContainer' aria-expanded='false' aria-controls='addprodContainer' -->
    </div>
    <!-- table - sample Details-->
    <!--Purge Table-->
    <div class="container" id="purge_div">
        <h5 class="text-center">Purge</h5>
        <table id="tbl-purge" class="display" border="1" style="width:100%">
            <thead style="background-color:cornflowerblue">
                <tr>
                    <th></th> <!--edit/delete buttons-->
                    <th>Date</th>
                    <th>Name</th>
                    <th>Temperature</th>
                    <th>Weight</th>
                    <th># Of Buckets</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            
        </table>

        <!--<button id="add_new_cook" data-toggle='collapse' data-target='#addprodContainer' aria-expanded='false' aria-controls='addprodContainer'>Add</button>-->
        <!-- collapse/Expend the addprodcontianer (bootstrap) data-toggle='collapse' data-target='#addprodContainer' aria-expanded='false' aria-controls='addprodContainer' -->
    </div>
    <!--Purge Table-->
    <!--Harvest Table-->
    <div class="container" id="harvest_div">
        <h5 class="text-center">Harvest</h5>
        <table id="tbl-harvest" class="display" border="1" style="width:100%">
            <thead style="background-color:cornflowerblue">
                <tr>
                    <th></th> <!--edit/delete buttons-->
                    <th>Date</th>
                    <th>Name</th>
                    <th>Temperature</th>
                    <th>Time For Tap 2</th>
                    <th>Total Time</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            
        </table>

        <!--<button id="add_new_cook" data-toggle='collapse' data-target='#addprodContainer' aria-expanded='false' aria-controls='addprodContainer'>Add</button>-->
        <!-- collapse/Expend the addprodcontianer (bootstrap) data-toggle='collapse' data-target='#addprodContainer' aria-expanded='false' aria-controls='addprodContainer' -->
    </div>
    <!--Harvest Table-->
    <!--Fermant Table-->
    <div class="container" id="fermant_div">
        <h5 class="text-center">Fermantation</h5>
        <table id="tbl-Fermant" class="display" border="1" style="width:100%">
            <thead style="background-color:cornflowerblue">
                <tr>
                    <th></th> <!--edit/delete buttons-->
                    <th>Date</th>
                    <th>Pressure Change</th>
                    <th>Tank Pressure</th>
                    <th>Tank Temperature</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            
        </table>

        <!--<button id="add_new_cook" data-toggle='collapse' data-target='#addprodContainer' aria-expanded='false' aria-controls='addprodContainer'>Add</button>-->
        <!-- collapse/Expend the addprodcontianer (bootstrap) data-toggle='collapse' data-target='#addprodContainer' aria-expanded='false' aria-controls='addprodContainer' -->
    </div>
    <!--Fermant Table-->

</body>

</html>